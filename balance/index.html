<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Balance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="balance.css">
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="brand">
                <i class="fas fa-bars hamburger-menu" onclick="toggleMenu()"></i>
                <div class="discord-pfp">
                    <img src="https://cdn.pfps.gg/pfps/8115-riley.png" alt="Profile Picture">
                </div>
            </div>
            <div class="balance">
                <i class="fas fa-wallet"></i>
                <span class="balance-amount">$1,234.56</span>
            </div>
        </div>
        <div class="menu-dropdown">
            <div class="menu-item" onclick="window.location.href='/dashboard/'">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
        </div>
    </header>

    <div class="balance-container">
        <div class="payment-methods">
            <div class="payment-method" onclick="selectPaymentMethod('cashapp')">
                <div class="payment-method-header">
                    <i class="fas fa-dollar-sign payment-method-icon"></i>
                    <h3 class="payment-method-title">Cash App</h3>
                </div>
                <p style="color: #fff;">Only when <span style="color: #6b46c1; text-shadow: 0 0 10px #6b46c1, 0 0 20px #6b46c1; cursor: pointer;" onclick="window.location.href='https://discordapp.com/users/1308104217998921799'">@lite</span> is on</p>
            </div>

            <div class="payment-method" onclick="selectPaymentMethod('paypal')">
                <div class="payment-method-header">
                    <i class="fab fa-paypal payment-method-icon"></i>
                    <h3 class="payment-method-title">PayPal</h3>
                </div>
                <p style="color: #fff;">Friends and Family - No note</p>
            </div>
            <div class="payment-method" onclick="selectPaymentMethod('crypto')">
                <div class="payment-method-header">
                    <i class="fab fa-bitcoin payment-method-icon"></i>
                    <h3 class="payment-method-title">Crypto</h3>
                </div>
                <p style="color: #fff;">BTC, ETH, LTC</p>
            </div>

            <div class="payment-method" onclick="selectPaymentMethod('other')">
                <div class="payment-method-header">
                    <i class="fas fa-money-bill-wave payment-method-icon"></i>
                    <h3 class="payment-method-title">Other Methods</h3>
                </div>
                <p style="color: #fff;">Venmo, Apple Pay, Zelle</p>
            </div>
        </div>
        
        <p id="select-method-text" style="color: #fff; text-align: center; margin-top: 2rem; font-size: 1.1rem; letter-spacing: 0.5px; opacity: 0.9; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Please select a payment method to continue.</p>
        
        <div id="payment-details" class="payment-details" style="display: none;">
            <form id="payment-form">
                <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="amount" required min="1" step="0.01">
                </div>

                <div class="form-group">
                    <label>Total Amount (Including Fee)</label>
                    <div id="total-display" style="color: #fff; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        Total: $0.00
                    </div>
                </div>

                <div id="payment-address-container" style="display: none;">
                    <label style="color: #fff;">Send payment to:</label>
                    <div class="payment-address" id="payment-address"></div>
                    <div id="crypto-copy-container" style="display: none;">
                        <select id="crypto-select" class="crypto-select">
                            <option value="">Select cryptocurrency...</option>
                            <option value="btc">Bitcoin (BTC)</option>
                            <option value="eth">Ethereum (ETH)</option>
                            <option value="ltc">Litecoin (LTC)</option>
                        </select>
                        <button type="button" class="copy-btn" onclick="copyCryptoAddress()">
                            <i class="fas fa-copy"></i> Copy Address
                        </button>
                    </div>
                    <button type="button" id="single-copy-btn" class="copy-btn" onclick="copyAddress()" style="display: none;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>

                <div class="form-group">
                    <label>Upload Payment Proof</label>
                    <input type="file" id="proof" required accept="image/*">
                </div>

                <button type="submit" class="submit-btn">Submit Payment</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDvG4059xSr2jToP9xDz-8dlxbumuRzdUE",
            authDomain: "sdfkj238j98sdlkmzlknslaksdjfkl.firebaseapp.com",
            projectId: "sdfkj238j98sdlkmzlknslaksdjfkl",
            storageBucket: "sdfkj238j98sdlkmzlknslaksdjfkl.firebasestorage.app",
            messagingSenderId: "778178162130",
            appId: "1:778178162130:web:a9513f09e404813aa2ec0b",
            measurementId: "G-WP6QR49WZ3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Payment method addresses
        const paymentAddresses = {
            cashapp: "$gu2u",
            paypal: "PayPal.me/ledallaaa",
            crypto: {
                btc: "bc1qs3x0dj4pzhxtq0e26x7uhdehuhlqqsvvx4843f",
                eth: "0x2C71Ee68A9Ec269377FCb49f04Ebf97c1241bBda",
                ltc: "LbXhE3tmkyiPNHwnojfLh9jB7u3XBhGRJK"
            },
            other: "+1 732-284-9260"
        };

        const fees = {
            cashapp: 0.05,
            paypal: 0.07,
            crypto: 0,
            other: 0.05
        };

        let selectedMethod = null;

        // Add this after Firebase initialization
        let processingPayment = false;

        // Update the payment form submit handler
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (processingPayment) {
                showAlert('Please wait for your current payment to be processed before submitting another.', 'error');
                return;
            }
            
            const amount = document.getElementById('amount').value;
            const proofFile = document.getElementById('proof').files[0];
            
            try {
                // Get current user data
                const username = localStorage.getItem('currentUser');
                if (!username) {
                    throw new Error('Not logged in');
                }

                // Check if user has any pending payments
                const pendingPayments = await db.collection('payments')
                    .where('userId', '==', username)
                    .where('status', '==', 'Pending')
                    .get();

                if (!pendingPayments.empty) {
                    showAlert('You already have a pending payment. Please wait for it to be processed.', 'error');
                    return;
                }

                processingPayment = true;

                // Upload proof image to litterbox
                const proofUrl = await uploadToLitterbox(proofFile);
                
                // Create payment record in Firebase
                await db.collection('payments').add({
                    userId: username,
                    amount: parseFloat(amount),
                    paymentMethod: selectedMethod,
                    proofUrl: proofUrl,
                    status: 'Pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert('Payment submitted successfully! Please wait for admin approval.', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard/';
                }, 2000);
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error submitting payment: ' + error.message, 'error');
            } finally {
                processingPayment = false;
            }
        });

        // Function to upload proof to litterbox
        async function uploadToLitterbox(file) {
            const formData = new FormData();
            formData.append('reqtype', 'fileupload');
            formData.append('time', '72h');
            formData.append('fileToUpload', file);

            const response = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload proof image');
            }

            const imageUrl = await response.text();
            return imageUrl.trim();
        }

        function selectPaymentMethod(method) {
            // Reset previous selection
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });

            // Select new method
            document.querySelector(`.payment-method:nth-child(${
                {cashapp: 1, paypal: 2, crypto: 3, other: 4}[method]
            })`).classList.add('selected');

            selectedMethod = method;
            updateFeeAndTotal();
            
            // Show payment details and hide select method text
            document.getElementById('payment-details').style.display = 'block';
            document.getElementById('select-method-text').style.display = 'none';
            
            // Show appropriate address
            const addressContainer = document.getElementById('payment-address-container');
            const addressElement = document.getElementById('payment-address');
            const cryptoCopyContainer = document.getElementById('crypto-copy-container');
            const singleCopyBtn = document.getElementById('single-copy-btn');
            
            if (method === 'crypto') {
                addressElement.innerHTML = `
                    BTC: ${paymentAddresses.crypto.btc}<br>
                    ETH: ${paymentAddresses.crypto.eth}<br>
                    LTC: ${paymentAddresses.crypto.ltc}
                `;
                cryptoCopyContainer.style.display = 'flex';
                singleCopyBtn.style.display = 'none';
            } else {
                addressElement.innerHTML = paymentAddresses[method];
                cryptoCopyContainer.style.display = 'none';
                singleCopyBtn.style.display = 'flex';
            }
            
            addressContainer.style.display = 'block';
        }

        function copyCryptoAddress() {
            const select = document.getElementById('crypto-select');
            const selectedCrypto = select.value;
            
            if (!selectedCrypto) {
                alert('Please select a cryptocurrency first');
                return;
            }
            
            const address = paymentAddresses.crypto[selectedCrypto];
            navigator.clipboard.writeText(address).then(() => {
                const copyBtn = document.querySelector('#crypto-copy-container .copy-btn');
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Address';
                }, 2000);
            });
        }

        function copyAddress() {
            const address = paymentAddresses[selectedMethod];
            navigator.clipboard.writeText(address).then(() => {
                const copyBtn = document.getElementById('single-copy-btn');
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                }, 2000);
            });
        }

        function updateFeeAndTotal() {
            const amountInput = document.getElementById('amount');
            const amount = parseFloat(amountInput.value) || 0;
            const totalDisplay = document.getElementById('total-display');
            
            if (!selectedMethod) {
                totalDisplay.textContent = 'Please select a payment method';
                return;
            }

            const feeRate = fees[selectedMethod];
            const feeAmount = amount * feeRate;
            const total = amount + feeAmount;
            
            totalDisplay.textContent = `Total: $${total.toFixed(2)}`;
        }

        // Initialize particles.js
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: '#ffffff' },
                shape: { type: 'circle' },
                opacity: {
                    value: 0.2,
                    random: true,
                    animation: { enable: true, speed: 1, minimumValue: 0.1, sync: false }
                },
                size: {
                    value: 3,
                    random: true,
                    animation: { enable: true, speed: 2, minimumValue: 0.1, sync: false }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.1,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'none',
                    random: true,
                    straight: false,
                    outModes: { default: 'bounce' },
                    attract: { enable: false, rotateX: 600, rotateY: 1200 }
                }
            },
            interactivity: {
                detectsOn: 'canvas',
                events: {
                    onHover: { enable: true, mode: 'repulse' },
                    onClick: { enable: true, mode: 'push' },
                    resize: true
                },
                modes: {
                    repulse: { distance: 100, duration: 0.4 },
                    push: { particles_nb: 4 }
                }
            },
            retina_detect: true
        });

        // Toggle menu dropdown
        function toggleMenu() {
            const dropdown = document.querySelector('.menu-dropdown');
            dropdown.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.menu-dropdown');
            const hamburger = document.querySelector('.hamburger-menu');
            if (!hamburger.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        async function loadUserProfile() {
            const username = localStorage.getItem('currentUser');
            if (!username) return;

            try {
                const userDoc = await db.collection('users').doc(username).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.discordAvatarURL) {
                        document.querySelector('.discord-pfp img').src = userData.discordAvatarURL;
                    }
                    // Update balance display
                    document.querySelector('.balance-amount').textContent = 
                        `$${userData.balance ? userData.balance.toFixed(2) : '0.00'}`;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Add this to initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
        });

        document.getElementById('amount').addEventListener('input', updateFeeAndTotal);

        // Add the showAlert function from admin.html
        function showAlert(message, type = 'info') {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Create alert element
            const alert = document.createElement('div');
            alert.className = `custom-alert ${type}`;
            
            // Set icon based on type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';

            alert.innerHTML = `
                <i class="fas fa-${icon} alert-icon"></i>
                <div class="alert-content">${message}</div>
                <div class="alert-close">
                    <i class="fas fa-times"></i>
                </div>
            `;

            // Add to document
            document.body.appendChild(alert);

            // Show alert
            setTimeout(() => alert.classList.add('show'), 10);

            // Add close handler
            alert.querySelector('.alert-close').onclick = () => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            };

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }
    </script>
</body>
</html>
