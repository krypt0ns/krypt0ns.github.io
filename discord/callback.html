<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Discord Login</title>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, setDoc, query, collection, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvG4059xSr2jToP9xDz-8dlxbumuRzdUE",
            authDomain: "sdfkj238j98sdlkmzlknslaksdjfkl.firebaseapp.com",
            projectId: "sdfkj238j98sdlkmzlknslaksdjfkl",
            storageBucket: "sdfkj238j98sdlkmzlknslaksdjfkl.firebasestorage.app",
            messagingSenderId: "778178162130",
            appId: "1:778178162130:web:a9513f09e404813aa2ec0b",
            measurementId: "G-WP6QR49WZ3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function getDiscordUser(code) {
            // Exchange code for access token
            const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                method: 'POST',
                body: new URLSearchParams({
                    client_id: '1325220923162230805',
                    client_secret: 'CnsILKBdkD12PUbU2HnoKCEE_dc6mfgZ',
                    code: code,
                    grant_type: 'authorization_code',
                    redirect_uri: 'https://www.krypt0n.net/discord/callback',
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            });

            const tokenData = await tokenResponse.json();

            // Get user info using the access token
            const userResponse = await fetch('https://discord.com/api/users/@me', {
                headers: {
                    Authorization: `Bearer ${tokenData.access_token}`,
                },
            });

            return await userResponse.json();
        }

        async function getIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return 'unknown';
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return null;
            }
        }

        async function handleCallback() {
            try {
                // Check for IP ban first
                const isBanned = await checkIPBan();
                if (isBanned) {
                    return; // The checkIPBan function will handle showing the ban message
                }

                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (!code) {
                    throw new Error('No authorization code received from Discord');
                }

                const pendingData = JSON.parse(sessionStorage.getItem('pendingRegistration'));
                if (!pendingData) {
                    window.location.href = '/register/';
                    throw new Error('No pending registration data');
                }

                if (Date.now() - pendingData.timestamp > 5 * 60 * 1000) {
                    throw new Error('Registration session expired');
                }

                // Get Discord user info
                const discordUser = await getDiscordUser(code);
                const ip = await getIP();

                // Check if Discord ID already exists
                const discordQuery = query(collection(db, "users"), where("discordId", "==", discordUser.id));
                const querySnapshot = await getDocs(discordQuery);
                
                if (!querySnapshot.empty) {
                    throw new Error('A user with this Discord account already exists');
                }

                // Get Discord avatar URL
                const avatarURL = discordUser.avatar 
                    ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`
                    : 'https://discord.com/assets/default-avatar.png';

                // Get IP before creating account
                const userIP = await getClientIP();

                // Store user data in Firestore with IP
                const userDocRef = doc(db, "users", pendingData.username);
                await setDoc(userDocRef, {
                    username: pendingData.username,
                    password: pendingData.password,
                    discordId: discordUser.id || null,
                    discordUsername: discordUser.username || null,
                    discordAvatarURL: avatarURL || null,
                    balance: 0,
                    createdAt: serverTimestamp(),
                    registrationIP: userIP || 'unknown',
                    ipHistory: [userIP || 'unknown'] // Array to track IP history
                });

                // Clear the pending registration data
                sessionStorage.removeItem('pendingRegistration');

                // Store login credentials and redirect
                localStorage.setItem('currentUser', pendingData.username);
                localStorage.setItem('userPassword', pendingData.password);
                window.location.href = '/dashboard/';

            } catch (error) {
                console.error('Error during registration:', error);
                document.body.innerHTML = `
                    <div style="color: red; padding: 20px;">
                        Error creating account: ${error.message}
                        <br><br>
                        <a href="/register/">Try again</a>
                    </div>
                `;
            }
        }

        // Execute when the page loads
        handleCallback();
    </script>
</body>
</html>