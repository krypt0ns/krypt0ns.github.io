<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Discord Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <script type="module">
        import { supabase } from '/config/supabase.js';
        import { validateStoredCredentials } from '/auth.js';

        async function getDiscordUser(code) {
            try {
                // First exchange the code for a token
                const tokenResponse = await fetch('https://www.krypt0n.net/discord/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                if (!tokenResponse.ok) {
                    throw new Error('Failed to exchange code for token');
                }

                const tokenData = await tokenResponse.json();

                // Then get the user info using the access token
                const userResponse = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Failed to get Discord user info');
                }

                return userResponse.json();
            } catch (error) {
                console.error('Discord authentication error:', error);
                throw new Error('Unable to connect to Discord servers. Please try again later.');
            }
        }

        async function handleCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (!code) {
                    throw new Error('No authorization code received from Discord');
                }

                const pendingData = JSON.parse(sessionStorage.getItem('pendingRegistration'));
                if (!pendingData || !pendingData.username || !pendingData.password || !pendingData.ip) {
                    throw new Error('Registration data not found. Please start over.');
                }

                if (Date.now() - pendingData.timestamp > 5 * 60 * 1000) {
                    sessionStorage.removeItem('pendingRegistration');
                    throw new Error('Registration session expired. Please try again.');
                }

                const discordUser = await getDiscordUser(code);

                const { data: existingUser, error: searchError } = await supabase
                    .from('users')
                    .select('username')
                    .eq('discord_id', discordUser.id)
                    .single();

                if (searchError && searchError.code !== 'PGRST116') {
                    console.error('Supabase search error:', searchError);
                    throw new Error('Error checking existing Discord account');
                }
                
                if (existingUser) {
                    throw new Error('A user with this Discord account already exists');
                }

                const avatarURL = discordUser.avatar 
                    ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`
                    : 'https://discord.com/assets/default-avatar.png';

                const { error: insertError } = await supabase
                    .from('users')
                    .insert([{
                        username: pendingData.username,
                        password: pendingData.password,
                        ip: pendingData.ip,
                        discord_id: discordUser.id,
                        discord_username: discordUser.username,
                        discord_avatar_url: avatarURL,
                        balance: 0,
                        created_at: new Date().toISOString(),
                        last_login: new Date().toISOString(),
                        status: 'Active'
                    }]);

                if (insertError) {
                    console.error('Supabase insert error:', insertError);
                    throw new Error('Error creating user account');
                }

                sessionStorage.removeItem('pendingRegistration');
                localStorage.setItem('currentUser', pendingData.username);
                localStorage.setItem('userPassword', pendingData.password);

                await validateStoredCredentials();
                window.location.replace('/dashboard/');
            } catch (error) {
                console.error('Registration error:', error);
                document.body.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: #0f0f0f;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-family: Arial, sans-serif;
                    ">
                        <div style="
                            background: rgba(255, 0, 0, 0.1);
                            border: 1px solid rgba(255, 0, 0, 0.2);
                            padding: 2rem;
                            border-radius: 12px;
                            text-align: center;
                            max-width: 80%;
                        ">
                            <h2 style="margin-bottom: 1rem;">Registration Error</h2>
                            <p style="margin-bottom: 1rem;">${error.message}</p>
                            <a href="/register/" style="
                                color: #fff;
                                text-decoration: none;
                                background: rgba(255, 255, 255, 0.1);
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                display: inline-block;
                                margin-top: 1rem;
                            ">Try Again</a>
                        </div>
                    </div>
                `;
            }
        }

        handleCallback();
    </script>
</body>
</html>