<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krypton | Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="admin.css">
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { supabase } from '../config/supabase.js';
        import { checkIPBan } from '../auth/auth.js';
        import { handleListingChange, handleUserChange, handlePaymentChange } from './realtime.js';
        
        window.supabase = supabase; // Make supabase available globally
        
        document.addEventListener('DOMContentLoaded', async () => {
            await checkIPBan();
        });
    </script>
    <!-- Add these script tags in the head section -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="particles-js"></div>
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="brand">
                <h1>Dashboard</h1>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>...</h3>
                <p>Active Listings</p>
            </div>
            <div class="stat-card">
                <h3>...</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card">
                <h3>...</h3>
                <p>Pending Orders</p>
            </div>
            <div class="stat-card">
                <h3>...</h3>
                <p>Total Revenue</p>
            </div>
        </div>

        <div class="admin-nav">
            <div class="nav-item active" onclick="showSection('listings', event)">Listings</div>
            <div class="nav-item" onclick="showSection('users', event)">Users</div>
            <div class="nav-item" onclick="showSection('orders', event)">Orders</div>
            <div class="nav-item" onclick="showSection('payments', event)">Payments</div>
            <div class="nav-item" onclick="showSection('discounts', event)">Discounts</div>
        </div>

        <div class="admin-content">
            <div id="listings-section" class="content-section">
                <div class="pending-orders-section" style="
                    background: rgba(237, 137, 54, 0.1);
                    border: 1px solid rgba(237, 137, 54, 0.2);
                    border-radius: 12px;
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                ">
                    <h3 style="
                        color: #ed8936;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    ">
                        <i class="fas fa-clock"></i> Pending Orders
                    </h3>
                    <div id="pending-orders-container">
                        <!-- Pending orders will be dynamically inserted here -->
                    </div>
                </div>
                <div class="filters-container" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <div class="search-box" style="flex: 1;">
                        <input 
                            type="text" 
                            id="listing-search" 
                            placeholder="Search listings..." 
                            style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff;"
                        >
                    </div>
                    <select 
                        id="listing-status-filter" 
                        style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; cursor: pointer;"
                    >
                        <option value="all">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Disabled">Disabled</option>
                    </select>
                </div>
                <button class="action-btn edit-btn" onclick="showNewListingForm()" style="margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> New Listing
                </button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Listing</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Info</th>
                        </tr>
                    </thead>
                    <tbody id="listings-table-body">
                        <!-- Listings will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="users-section" class="content-section" style="display: none;">
                <div class="filters-container" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <div class="search-box" style="flex: 1;">
                        <input 
                            type="text" 
                            id="user-search" 
                            placeholder="Search users..." 
                            style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff;"
                        >
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Info</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Users will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="orders-section" class="content-section" style="display: none;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>User</th>
                            <th>Item</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Orders will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="payments-section" class="content-section" style="display: none;">
                <div class="filters-container" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <div class="search-box" style="flex: 1;">
                        <input 
                            type="text" 
                            id="payment-search" 
                            placeholder="Search by username..." 
                            style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff;"
                        >
                    </div>
                    <select 
                        id="status-filter" 
                        style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; cursor: pointer;"
                    >
                        <option value="all" style="background: #1a1a1a; color: #fff;">All Status</option>
                        <option value="Pending" style="background: #1a1a1a; color: #ed8936;">Pending</option>
                        <option value="Completed" style="background: #1a1a1a; color: #48bb78;">Completed</option>
                        <option value="Rejected" style="background: #1a1a1a; color: #e53e3e;">Rejected</option>
                    </select>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Payments will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Add this inside the admin-content div, alongside the other sections -->
            <div id="discounts-section" class="content-section" style="display: none;">
                <div class="filters-container">
                    <div class="search-box">
                        <input type="text" id="discount-search" placeholder="Search discount codes...">
                    </div>
                    <button class="action-btn" onclick="showAddDiscountModal()">
                        <i class="fas fa-plus"></i> New Discount
                    </button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount %</th>
                            <th>Status</th>
                            <th>Uses</th>
                            <th>Max Uses</th>
                            <th>Expiry</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="discount-codes-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add this section inside your admin panel's main content area -->
    <div class="admin-section" id="discount-management" style="display: none;">
        <div class="section-header">
            <h2>Discount Management</h2>
            <button class="add-btn" onclick="showAddDiscountModal()">
                <i class="fas fa-plus"></i> Add New Discount
            </button>
        </div>
        <div class="discount-list">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount %</th>
                            <th>Status</th>
                            <th>Uses</th>
                            <th>Max Uses</th>
                            <th>Expiry</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="discount-codes-table">
                        <!-- Discount codes will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Discount Modal -->
    <div class="modal" id="add-discount-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddDiscountModal()">&times;</span>
            <h2>Add New Discount Code</h2>
            <form id="add-discount-form" onsubmit="handleAddDiscount(event)">
                <div class="form-group">
                    <input type="text" id="discount-code" placeholder="Discount Code" required>
                    <label for="discount-code">Discount Code</label>
                </div>
                <div class="form-group">
                    <input type="number" id="discount-percentage" placeholder="Discount Percentage" required min="1" max="100">
                    <label for="discount-percentage">Discount Percentage</label>
                </div>
                <div class="form-group">
                    <input type="number" id="max-uses" placeholder="Maximum Uses" required min="1">
                    <label for="max-uses">Maximum Uses</label>
                </div>
                <div class="form-group">
                    <input type="datetime-local" id="expiry-date" required>
                    <label for="expiry-date">Expiry Date</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-btn">
                        <i class="fas fa-plus"></i> Create Discount
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: '#ffffff' },
                shape: { type: 'circle' },
                opacity: {
                    value: 0.2,
                    random: true,
                    animation: { enable: true, speed: 1, minimumValue: 0.1, sync: false }
                },
                size: {
                    value: 3,
                    random: true,
                    animation: { enable: true, speed: 2, minimumValue: 0.1, sync: false }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.1,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'none',
                    random: true,
                    straight: false,
                    outModes: { default: 'bounce' },
                    attract: { enable: false, rotateX: 600, rotateY: 1200 }
                }
            },
            interactivity: {
                detectsOn: 'canvas',
                events: {
                    onHover: { enable: true, mode: 'repulse' },
                    onClick: { enable: true, mode: 'push' },
                    resize: true
                },
                modes: {
                    repulse: { distance: 100, duration: 0.4 },
                    push: { particles_nb: 4 }
                }
            },
            retina_detect: true
        });

        function showSection(sectionName, event) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            document.getElementById(`${sectionName}-section`).style.display = 'block';
            
            // Initialize appropriate listener based on section
            if (sectionName === 'orders') {
                initializeOrdersListener();
            } else if (sectionName === 'listings') {
                initializeListingsListener();
            } else if (sectionName === 'users') {
                initializeUsersListener();
            } else if (sectionName === 'payments') {
                initializePaymentsListener();
            } else if (sectionName === 'discounts') {
                initializeDiscountsListener();
            }
            
            if (event) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }

        function showNewListingForm() {
            const listingsSection = document.getElementById('listings-section');
            listingsSection.innerHTML = `
                <div class="admin-form">
                    <div class="form-group">
                        <input type="text" id="listing-title" required placeholder=" ">
                        <label>Title</label>
                    </div>
                    <div class="form-group">
                        <input type="number" id="listing-price" step="0.01" required placeholder=" ">
                        <label>Price</label>
                    </div>
                    <div class="form-group">
                        <textarea id="listing-description" rows="4" required placeholder=" "></textarea>
                        <label>Description</label>
                    </div>
            <!-- Removed release time input -->
            <div class="form-group">
                <input type="text" id="account-username" placeholder=" ">
                <label>Account Username</label>
            </div>
            <div class="form-group">
                <input type="text" id="account-password" placeholder=" ">
                <label>Account Password</label>
            </div>
            <div class="form-group file-input-group">
                <input type="file" id="listing-image" accept="image/*" required>
                <label for="listing-image" class="file-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Choose Image</span>
                </label>
                <div class="file-info">Image will be available for 72 hours</div>
            </div>
            <div class="info-message" style="margin-bottom: 1rem; color: #ed8936; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i>
                After creating the listing, use the "Drop Now" button to make it available to all users simultaneously.
            </div>
            <div class="form-group">
                <input type="datetime-local" id="listing-drop-time" required placeholder=" ">
                <label>Drop Time</label>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="action-btn edit-btn" onclick="handleListingSubmit()">Create Listing</button>
                <button class="action-btn cancel" onclick="showListingsTable()">Cancel</button>
            </div>
        </div>
    `;

            // Update the file input change handler
            document.getElementById('listing-image').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Choose Image';
                const fileLabel = e.target.nextElementSibling.querySelector('span');
                fileLabel.textContent = fileName;
                fileLabel.classList.add('has-file');
            });
        }

        function showListingsTable() {
            const listingsSection = document.getElementById('listings-section');
            listingsSection.innerHTML = `
                <div class="filters-container" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <div class="search-box" style="flex: 1;">
                        <input 
                            type="text" 
                            id="listing-search" 
                            placeholder="Search listings..." 
                            style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff;"
                        >
                    </div>
                    <select 
                        id="listing-status-filter" 
                        style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; cursor: pointer;"
                    >
                        <option value="all">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Disabled">Disabled</option>
                    </select>
                </div>
                <button class="action-btn edit-btn" onclick="showNewListingForm()" style="margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> New Listing
                </button>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Listing</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Info</th>
                        </tr>
                    </thead>
                    <tbody id="listings-table-body">
                        <!-- Listings will be inserted here -->
                    </tbody>
                </table>
            `;

            // Initialize listeners after creating the elements
            initializeListingsListener();
        }

        async function handleListingSubmit() {
            const formData = {
                title: document.getElementById('listing-title').value,
                price: document.getElementById('listing-price').value,
                description: document.getElementById('listing-description').value,
                image: document.getElementById('listing-image').files[0],
                dropTime: new Date(document.getElementById('listing-drop-time').value).getTime(),
                accountDetails: {
                    username: document.getElementById('account-username').value.trim(),
                    password: document.getElementById('account-password').value.trim()
                }
            };

            if (!formData.title || !formData.price || !formData.description || !formData.image) {
                showAlert('Please fill in all required fields.', 'error');
                return;
            }

            try {
                const imageUrl = await uploadToLitterbox(formData.image);
                formData.imageUrl = imageUrl;
                delete formData.image;
                
                await createListing(formData);
            } catch (error) {
                console.error('Error:', error);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function uploadToLitterbox(file) {
            const formData = new FormData();
            formData.append('reqtype', 'fileupload');
            formData.append('time', '72h'); // Files will be available for 72 hours
            formData.append('fileToUpload', file);

            const response = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload image');
            }

            const imageUrl = await response.text();
            return imageUrl.trim();
        }

        async function createListing(formData) {
            try {
                const { data, error } = await supabase
                    .from('listings')
                    .insert([{
                        title: formData.title,
                        price: parseFloat(formData.price),
                        description: formData.description,
                        image_url: formData.imageUrl,
                        status: 'Active',
                        release_time: formData.dropTime,
                        created_at: new Date().toISOString(),
                        account_details: formData.accountDetails,
                        countdown: {
                            active: false,
                            end_time: null,
                            start_time: null,
                            duration: null
                        }
                    }]);

                if (error) throw error;
                showAlert('Listing created successfully!', 'success');
                showListingsTable();
            } catch (error) {
                console.error('Error creating listing:', error);
                showAlert(`Error creating listing: ${error.message}`, 'error');
            }
        }

        // Add these variables at the top of your script
        let allListings = [];
        let listingSearchTerm = '';
        let listingStatusFilter = 'all';

        // Replace the initializeListingsListener function
        async function initializeListingsListener() {
            try {
                const { data: listings, error } = await supabase
                    .from('listings')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                // Update the UI with listings data
                updateListingsTable(listings);
                
                // Subscribe to realtime changes
                const listingsSubscription = supabase
                    .channel('listings_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'listings' },
                        payload => {
                            handleListingChange(payload);
                        }
                    )
                    .subscribe();
                    
            } catch (error) {
                console.error('Error initializing listings:', error);
                showAlert('Error loading listings', 'error');
            }
        }

        // Replace the initializeUsersListener function
        async function initializeUsersListener() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                updateUsersTable(users);
                
                // Subscribe to realtime changes
                const usersSubscription = supabase
                    .channel('users_changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'users' },
                        payload => {
                            handleUserChange(payload);
                        }
                    )
                    .subscribe();
                    
            } catch (error) {
                console.error('Error initializing users:', error);
                showAlert('Error loading users', 'error');
            }
        }

        // Replace the initializePaymentsListener function
        async function initializePaymentsListener() {
            try {
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                updatePaymentsTable(payments);
                
                // Subscribe to realtime changes
                const paymentsSubscription = supabase
                    .channel('payments_changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'payments' },
                        payload => {
                            handlePaymentChange(payload);
                        }
                    )
                    .subscribe();
                    
                } catch (error) {
                console.error('Error initializing payments:', error);
                showAlert('Error loading payments', 'error');
            }
        }

        // Replace the initializeStatsListeners function
        async function initializeStatsListeners() {
            try {
                // Get active listings count
                const { count: activeListings, error: listingsError } = await supabase
                    .from('listings')
                    .select('*', { count: 'exact' })
                    .eq('status', 'Active');
                    
                if (listingsError) throw listingsError;

                // Get total users count
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact' });
                    
                if (usersError) throw usersError;

                // Get pending orders count
                const { count: pendingOrders, error: ordersError } = await supabase
                    .from('payments')
                    .select('*', { count: 'exact' })
                    .eq('status', 'Pending');
                    
                if (ordersError) throw ordersError;

                // Calculate total revenue
                const { data: completedPayments, error: revenueError } = await supabase
                    .from('payments')
                    .select('amount')
                    .eq('status', 'Completed');
                    
                if (revenueError) throw revenueError;
                
                const totalRevenue = completedPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);

                // Update stats display
                updateStatsDisplay(activeListings, totalUsers, pendingOrders, totalRevenue);
                
                } catch (error) {
                console.error('Error initializing stats:', error);
                showAlert('Error loading statistics', 'error');
            }
        }

        // Update the DOMContentLoaded event listener to include stats initialization
        document.addEventListener('DOMContentLoaded', () => {
            initializeListingsListener();
            initializeUsersListener();
            initializePaymentsListener();
            initializeStatsListeners();
        });

        function showAlert(message, type = 'info') {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Create alert element
            const alert = document.createElement('div');
            alert.className = `custom-alert ${type}`;
            
            // Set icon based on type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';

            alert.innerHTML = `
                <i class="fas fa-${icon} alert-icon"></i>
                <div class="alert-content">${message}</div>
                <div class="alert-close">
                    <i class="fas fa-times"></i>
                </div>
            `;

            // Add to document
            document.body.appendChild(alert);

            // Show alert
            setTimeout(() => alert.classList.add('show'), 10);

            // Add close handler
            alert.querySelector('.alert-close').onclick = () => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            };

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                
                const dialog = document.createElement('div');
                dialog.className = 'custom-confirm';
                
                dialog.innerHTML = `
                    <h3 class="confirm-title">${title}</h3>
                    <p class="confirm-message">${message}</p>
                    <div class="confirm-buttons">
                        <button class="confirm-button cancel">Cancel</button>
                        <button class="confirm-button confirm">Confirm</button>
                    </div>
                `;

                document.body.appendChild(overlay);
                document.body.appendChild(dialog);

                // Show with animation
                setTimeout(() => {
                    overlay.classList.add('show');
                    dialog.classList.add('show');
                }, 10);

                function closeDialog(result) {
                    overlay.classList.remove('show');
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                        dialog.remove();
                        resolve(result);
                    }, 300);
                }

                dialog.querySelector('.confirm-button.cancel').onclick = () => closeDialog(false);
                dialog.querySelector('.confirm-button.confirm').onclick = () => closeDialog(true);
                overlay.onclick = () => closeDialog(false);
            });
        }

        function showPrompt(title, message, defaultValue = '') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                
                const dialog = document.createElement('div');
                dialog.className = 'custom-prompt';
                
                dialog.innerHTML = `
                    <h3 class="prompt-title">${title}</h3>
                    <p class="confirm-message">${message}</p>
                    <input type="text" class="prompt-input" value="${defaultValue}">
                    <div class="confirm-buttons">
                        <button class="confirm-button cancel">Cancel</button>
                        <button class="confirm-button confirm">Confirm</button>
                    </div>
                `;

                document.body.appendChild(overlay);
                document.body.appendChild(dialog);

                const input = dialog.querySelector('.prompt-input');
                input.focus();

                // Show with animation
                setTimeout(() => {
                    overlay.classList.add('show');
                    dialog.classList.add('show');
                }, 10);

                function closeDialog(result) {
                    overlay.classList.remove('show');
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                        dialog.remove();
                        resolve(result === false ? null : input.value);
                    }, 300);
                }

                dialog.querySelector('.confirm-button.cancel').onclick = () => closeDialog(false);
                dialog.querySelector('.confirm-button.confirm').onclick = () => closeDialog(true);
                overlay.onclick = () => closeDialog(false);

                // Handle Enter key
                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') closeDialog(true);
                    if (e.key === 'Escape') closeDialog(false);
                });
            });
        }

        // Add these pagination variables at the top with your other global variables
        let currentOrdersPage = 1;
        let currentPaymentsPage = 1;
        const itemsPerPage = 10;

        // Update the initializeOrdersListener function
        function initializeOrdersListener() {
            const tableBody = document.querySelector('#orders-section tbody');
            if (!tableBody) return;
            
            // Remove any existing pagination controls
            const existingPagination = document.querySelector('#orders-section .pagination-controls');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            // Add pagination controls
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'pagination-controls';
            paginationContainer.style.cssText = `
                margin-top: 1rem;
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                align-items: center;
            `;
            document.querySelector('#orders-section').appendChild(paginationContainer);
            
            db.collection('orders')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    const allOrders = [];
                    snapshot.forEach((doc) => {
                        allOrders.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Calculate pagination
                    const totalPages = Math.ceil(allOrders.length / itemsPerPage);
                    const startIndex = (currentOrdersPage - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const ordersToShow = allOrders.slice(startIndex, endIndex);
                    
                    tableBody.innerHTML = '';
                    
                    ordersToShow.forEach((order) => {
                        const timestamp = order.createdAt?.toDate() || new Date();
                        
                        const row = `
                            <tr>
                                <td>#${order.id.slice(-6).toUpperCase()}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <img src="${order.userAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
                                             alt="${order.username}" 
                                             style="width: 32px; height: 32px; border-radius: 50%;">
                                        ${order.username}
                                    </div>
                                </td>
                                <td>${order.listingTitle}</td>
                                <td>$${order.price}</td>
                                <td>
                                    <span class="status-badge ${order.status.toLowerCase()}">
                                        ${order.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn info-btn" onclick="showOrderInfo('${order.id}')" 
                                            style="background: rgba(66, 153, 225, 0.1); color: #4299e1; margin-right: 0.5rem;">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                    ${order.status === 'Pending' ? `
                                        <button class="action-btn edit-btn" onclick="approveOrder('${order.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn delete-btn" onclick="rejectOrder('${order.id}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                    // Update pagination controls
                    paginationContainer.innerHTML = `
                        <button class="pagination-btn" 
                                onclick="changeOrdersPage(1)" 
                                ${currentOrdersPage === 1 ? 'disabled' : ''}
                                style="opacity: ${currentOrdersPage === 1 ? '0.5' : '1'}">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" 
                                onclick="changeOrdersPage(${currentOrdersPage - 1})" 
                                ${currentOrdersPage === 1 ? 'disabled' : ''}
                                style="opacity: ${currentOrdersPage === 1 ? '0.5' : '1'}">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span style="color: white; margin: 0 1rem;">
                            Page ${currentOrdersPage} of ${totalPages}
                        </span>
                        <button class="pagination-btn" 
                                onclick="changeOrdersPage(${currentOrdersPage + 1})" 
                                ${currentOrdersPage === totalPages ? 'disabled' : ''}
                                style="opacity: ${currentOrdersPage === totalPages ? '0.5' : '1'}">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" 
                                onclick="changeOrdersPage(${totalPages})" 
                                ${currentOrdersPage === totalPages ? 'disabled' : ''}
                                style="opacity: ${currentOrdersPage === totalPages ? '0.5' : '1'}">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    `;
                });
        }

        // Add the changeOrdersPage function
        function changeOrdersPage(newPage) {
            currentOrdersPage = newPage;
            initializeOrdersListener();
        }

        // Update the initializePaymentsListener function
        function initializePaymentsListener() {
            const tableBody = document.querySelector('#payments-section .admin-table tbody');
            const searchInput = document.getElementById('payment-search');
            const statusSelect = document.getElementById('status-filter');
            
            if (!tableBody) return;

            // Add pagination controls
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'pagination-controls';
            paginationContainer.style.cssText = `
                margin-top: 1rem;
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                align-items: center;
            `;
            document.querySelector('#payments-section').appendChild(paginationContainer);

            // Add event listeners for search and filter
            searchInput.addEventListener('input', () => {
                currentPaymentsPage = 1; // Reset to first page on search
                renderPayments();
            });

            statusSelect.addEventListener('change', () => {
                currentPaymentsPage = 1; // Reset to first page on filter change
                renderPayments();
            });

            db.collection('payments')
                .orderBy('timestamp', 'desc')
                .onSnapshot(async (snapshot) => {
                    allPayments = [];
                    for (const doc of snapshot.docs) {
                        const payment = doc.data();
                        const userDoc = await db.collection('users').doc(payment.userId).get();
                        const userData = userDoc.data();
                        
                        allPayments.push({
                            id: doc.id,
                            ...payment,
                            userData
                        });
                    }
                    renderPayments();
                });
        }

        // Update the renderPayments function
        function renderPayments() {
            const tableBody = document.querySelector('#payments-section .admin-table tbody');
            const paginationContainer = document.querySelector('#payments-section .pagination-controls');
            const searchTerm = document.getElementById('payment-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            if (!tableBody || !paginationContainer) return;
            
            // Filter payments
            const filteredPayments = allPayments.filter(payment => {
                const matchesSearch = payment.userData?.username?.toLowerCase().includes(searchTerm) ||
                                    payment.id.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || payment.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            // Calculate pagination
            const totalPages = Math.ceil(filteredPayments.length / itemsPerPage);
            const startIndex = (currentPaymentsPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paymentsToShow = filteredPayments.slice(startIndex, endIndex);

            // Clear and render table
            tableBody.innerHTML = '';
            paymentsToShow.forEach(payment => {
                const timestamp = payment.timestamp?.toDate() || new Date();
                const formattedDate = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString();
                
                const row = `
                    <tr>
                        <td>#${payment.id.slice(-6).toUpperCase()}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${payment.userData?.discordAvatarURL || 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
                                     alt="${payment.userData?.username}" 
                                     style="width: 32px; height: 32px; border-radius: 50%;">
                                ${payment.userData?.username || 'Unknown User'}
                            </div>
                        </td>
                        <td>$${payment.amount.toFixed(2)}</td>
                        <td>${payment.paymentMethod}</td>
                        <td>
                            <span class="status-badge ${payment.status.toLowerCase()}">
                                ${payment.status}
                            </span>
                        </td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="viewPaymentDetails('${payment.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${payment.status === 'Pending' ? `
                                <button class="action-btn edit-btn" onclick="updatePaymentStatus('${payment.id}', 'Completed')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="updatePaymentStatus('${payment.id}', 'Rejected')">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update pagination controls
            paginationContainer.innerHTML = `
                <button class="pagination-btn" 
                        onclick="changePaymentsPage(1)" 
                        ${currentPaymentsPage === 1 ? 'disabled' : ''}
                        style="opacity: ${currentPaymentsPage === 1 ? '0.5' : '1'}">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="pagination-btn" 
                        onclick="changePaymentsPage(${currentPaymentsPage - 1})" 
                        ${currentPaymentsPage === 1 ? 'disabled' : ''}
                        style="opacity: ${currentPaymentsPage === 1 ? '0.5' : '1'}">
                    <i class="fas fa-angle-left"></i>
                </button>
                <span style="color: white; margin: 0 1rem;">
                    Page ${currentPaymentsPage} of ${totalPages}
                </span>
                <button class="pagination-btn" 
                        onclick="changePaymentsPage(${currentPaymentsPage + 1})" 
                        ${currentPaymentsPage === totalPages ? 'disabled' : ''}
                        style="opacity: ${currentPaymentsPage === totalPages ? '0.5' : '1'}">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="pagination-btn" 
                        onclick="changePaymentsPage(${totalPages})" 
                        ${currentPaymentsPage === totalPages ? 'disabled' : ''}
                        style="opacity: ${currentPaymentsPage === totalPages ? '0.5' : '1'}">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            `;
        }

        // Add the changePaymentsPage function
        function changePaymentsPage(newPage) {
            currentPaymentsPage = newPage;
            renderPayments();
        }

        // Update the approveOrder function to handle balance deduction
        async function approveOrder(orderId) {
            try {
                const orderRef = db.collection('orders').doc(orderId);
                const orderDoc = await orderRef.get();
                const orderData = orderDoc.data();

                // Get listing data
                const listingDoc = await db.collection('listings').doc(orderData.listingId).get();
                const listingData = listingDoc.data();

                if (!orderDoc.exists || !listingDoc.exists) {
                    showAlert('Order or listing not found', 'error');
                    return;
                }

                const batch = db.batch();

                // If payment method is balance, deduct the balance now
                if (orderData.paymentMethod === 'balance') {
                    const userRef = db.collection('users').doc(orderData.userId);
                    const userDoc = await userRef.get();
                    const userData = userDoc.data();

                    // Check if user has sufficient balance
                    if (!userData || userData.balance < orderData.price) {
                        showAlert('User has insufficient balance', 'error');
                        return;
                    }

                    // Deduct balance
                    batch.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(-orderData.price)
                    });
                }

                // Update order status and include account details
                batch.update(orderRef, {
                    status: 'Completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    accountDetails: listingData.accountDetails || null
                });

                await batch.commit();
                showAlert('Order approved successfully', 'success');
                
            } catch (error) {
                console.error('Error approving order:', error);
                showAlert('Error approving order: ' + error.message, 'error');
            }
        }

        // Update the rejectOrder function to remove the balance refund
        async function rejectOrder(orderId) {
            const confirmed = await showConfirm(
                'Reject Order',
                'Are you sure you want to reject this order?'
            );

            if (confirmed) {
                try {
                    const orderRef = db.collection('orders').doc(orderId);
                    const orderDoc = await orderRef.get();
                    const orderData = orderDoc.data();

                    const batch = db.batch();

                    // Update order status
                    batch.update(orderRef, {
                        status: 'Rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Remove pending status from listing
                    batch.update(db.collection('listings').doc(orderData.listingId), {
                        pendingOrder: false,
                        verifiedBuyer: null // Clear the verified buyer
                    });

                    await batch.commit();
                    showAlert('Order rejected successfully', 'success');
                } catch (error) {
                    console.error('Error rejecting order:', error);
                    showAlert('Error rejecting order: ' + error.message, 'error');
                }
            }
        }

        // Add countdown management functions
        async function manageCountdown() {
            try {
                const countdownDoc = await db.collection('settings').doc('countdown').get();
                const currentSettings = countdownDoc.data() || { active: false, endTime: null };

                const dialog = document.createElement('div');
                dialog.className = 'custom-prompt';
                dialog.innerHTML = `
                    <h3 class="prompt-title">Manage Countdown</h3>
                    <div class="countdown-settings">
                        <div class="countdown-input">
                            <label>Hours:</label>
                            <input type="number" id="hours" min="0" value="0">
                            <label>Minutes:</label>
                            <input type="number" id="minutes" min="0" max="59" value="0">
                            <label>Seconds:</label>
                            <input type="number" id="seconds" min="0" max="59" value="0">
                        </div>
                        <div class="countdown-status">
                            Status: 
                            <span class="${currentSettings.active ? 'countdown-active' : 'countdown-inactive'}">
                                ${currentSettings.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="confirm-buttons" style="margin-top: 1rem;">
                        ${currentSettings.active ? 
                            '<button class="confirm-button cancel" onclick="stopCountdown()">Stop Countdown</button>' :
                            ''
                        }
                        <button class="confirm-button confirm">Start Countdown</button>
                    </div>
                `;

                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';

                document.body.appendChild(overlay);
                document.body.appendChild(dialog);

                setTimeout(() => {
                    overlay.classList.add('show');
                    dialog.classList.add('show');
                }, 10);

                // Handle start countdown
                dialog.querySelector('.confirm-button.confirm').onclick = async () => {
                    const hours = parseInt(document.getElementById('hours').value) || 0;
                    const minutes = parseInt(document.getElementById('minutes').value) || 0;
                    const seconds = parseInt(document.getElementById('seconds').value) || 0;

                    const totalMilliseconds = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    if (totalMilliseconds <= 0) {
                        showAlert('Please enter a valid time', 'error');
                        return;
                    }

                    const endTime = Date.now() + totalMilliseconds;

                    try {
                        await db.collection('settings').doc('countdown').set({
                            active: true,
                            endTime: endTime,
                            startTime: Date.now(),
                            duration: totalMilliseconds
                        });

                        showAlert('Countdown started successfully!', 'success');
                        closeDialog();
                    } catch (error) {
                        console.error('Error starting countdown:', error);
                        showAlert('Error starting countdown: ' + error.message, 'error');
                    }
                };

                function closeDialog() {
                    overlay.classList.remove('show');
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                        dialog.remove();
                    }, 300);
                }

                overlay.onclick = closeDialog;
            } catch (error) {
                console.error('Error managing countdown:', error);
                showAlert('Error managing countdown: ' + error.message, 'error');
            }
        }

        async function stopCountdown() {
            const confirmed = await showConfirm(
                'Stop Countdown',
                'Are you sure you want to stop the current countdown?'
            );

            if (confirmed) {
                try {
                    await db.collection('settings').doc('countdown').update({
                        active: false,
                        endTime: null
                    });
                    showAlert('Countdown stopped successfully', 'success');
                } catch (error) {
                    console.error('Error stopping countdown:', error);
                    showAlert('Error stopping countdown: ' + error.message, 'error');
                }
            }
        }

        // Add the pending orders listener
        function initializePendingOrdersListener() {
            const container = document.getElementById('pending-orders-container');
            if (!container) return;

            db.collection('orders')
                .where('status', '==', 'Pending')
                .orderBy('createdAt', 'desc')
                .onSnapshot(async (snapshot) => {
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <p style="color: rgba(255, 255, 255, 0.7); text-align: center;">
                                No pending orders at the moment
                            </p>
                        `;
                        return;
                    }

                    container.innerHTML = `
                        <table class="admin-table" style="margin-top: 1rem;">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Title</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${await Promise.all(snapshot.docs.map(async (doc) => {
                                    const order = doc.data();
                                    const listingDoc = await db.collection('listings').doc(order.listingId).get();
                                    const listing = listingDoc.data();
                                    
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <img src="${order.userAvatar}" alt="${order.username}" 
                                                         style="width: 32px; height: 32px; border-radius: 50%;">
                                                    <span style="color: white;">${order.username}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <img src="${listing.imageUrl}" alt="${listing.title}"
                                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                                    <span style="color: white;">${listing.title}</span>
                                                </div>
                                            </td>
                                            <td style="color: #6b46c1;">$${order.price}</td>
                                            <td>
                                                <span class="status-badge pending">Pending</span>
                                            </td>
                                            <td>
                                                <button class="action-btn edit-btn" 
                                                        onclick="approveOrder('${doc.id}')"
                                                        style="padding: 0.5rem;">
                                                    <i class="fas fa-check"></i> Approve
                                                </button>
                                                <button class="action-btn delete-btn"
                                                        onclick="rejectOrder('${doc.id}')"
                                                        style="padding: 0.5rem;">
                                                    <i class="fas fa-times"></i> Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }))}
                            </tbody>
                        </table>
                    `;
                });
        }

        async function toggleListingStatus(listingId, currentStatus) {
            const newStatus = currentStatus === 'Disabled' ? 'Active' : 'Disabled';
            const confirmed = await showConfirm(
                `${newStatus === 'Disabled' ? 'Disable' : 'Enable'} Listing`,
                `Are you sure you want to ${newStatus === 'Disabled' ? 'disable' : 'enable'} this listing?`
            );
            
            if (confirmed) {
                try {
                    await db.collection('listings').doc(listingId).update({
                        status: newStatus
                    });
                    showAlert(`Listing ${newStatus.toLowerCase()} successfully`, 'success');
                } catch (error) {
                    console.error('Error updating listing status:', error);
                    showAlert('Error updating listing status: ' + error.message, 'error');
                }
            }
        }

        async function viewListingDetails(listingId) {
            try {
                const listingDoc = await db.collection('listings').doc(listingId).get();
                const listing = listingDoc.data();
                
                // Get captcha winner information
                let buyerInfo = 'Not available';
                if (listing.captchaWinner) {
                    buyerInfo = `
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Captcha Winner: ${listing.captchaWinner.username}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                Verified at: ${listing.captchaWinner.verifiedAt?.toDate().toLocaleString() || 'N/A'}
                            </div>
                        </div>
                    `;
                }

                const detailsHTML = `
                    <div class="payment-details-content">
                        <div class="details-header">
                            <h3>Listing Details</h3>
                            <div class="buyer-info">
                                <strong>Buyer:</strong> ${buyerInfo}
                            </div>
                            <div class="alert-close">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                        <div class="details-body">
                            <div class="detail-row">
                                <span class="detail-label">Title:</span>
                                <span class="detail-value">${listing.title}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Price:</span>
                                <span class="detail-value">$${listing.price}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="status-badge ${listing.status.toLowerCase()}">${listing.status}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Release Date:</span>
                                <span class="detail-value">${new Date(listing.releaseTime).toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Sold Date:</span>
                                <span class="detail-value">${listing.soldAt ? new Date(listing.soldAt.toDate()).toLocaleString() : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Description:</span>
                                <span class="detail-value">${listing.description}</span>
                            </div>
                            <div class="proof-section">
                                <span class="detail-label">Image:</span>
                                <img src="${listing.imageUrl}" alt="${listing.title}" class="proof-image">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Credentials:</span>
                                <div class="account-credentials-input">
                                    <div class="input-group">
                                        <label>Username:</label>
                                        <input type="text" id="account-username" value="${listing.accountDetails?.username || ''}" 
                                               placeholder="Account username">
                                    </div>
                                    <div class="input-group">
                                        <label>Password:</label>
                                        <input type="text" id="account-password" value="${listing.accountDetails?.password || ''}" 
                                               placeholder="Account password">
                                    </div>
                                    <button class="action-btn edit-btn" onclick="saveAccountDetails('${listingId}')">
                                        Save Credentials
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Create and show modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    backdrop-filter: blur(5px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                    padding: 20px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                modal.innerHTML = detailsHTML;
                document.body.appendChild(modal);

                // Show with animation
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                });

                // Close handlers
                const closeBtn = modal.querySelector('.alert-close');
                const closeModal = () => {
                    modal.style.opacity = '0';
                    setTimeout(() => modal.remove(), 300);
                };

                closeBtn.onclick = closeModal;
                modal.onclick = (e) => {
                    if (e.target === modal) closeModal();
                };
            } catch (error) {
                console.error('Error viewing listing details:', error);
                showAlert('Error loading listing details', 'error');
            }
        }

        // Function to start countdown for a listing
        async function startCountdown(listingId, duration) {
            try {
                const now = Date.now();
                const { error } = await supabase
                    .from('listings')
                    .update({
                        countdown: {
                            active: true,
                            start_time: now,
                            end_time: now + (parseInt(duration) * 60000),
                            duration: parseInt(duration)
                        }
                    })
                    .eq('id', listingId);

                if (error) throw error;
                showAlert('Countdown started successfully', 'success');
            } catch (error) {
                console.error('Error starting countdown:', error);
                showAlert('Error starting countdown', 'error');
            }
        }

        // Function to stop countdown for a listing
        async function stopCountdown(listingId) {
            try {
                const { error } = await supabase
                    .from('listings')
                    .update({
                        countdown: {
                            active: false,
                            end_time: null,
                            start_time: null,
                            duration: null
                        }
                    })
                    .eq('id', listingId);

                if (error) throw error;
                showAlert('Countdown stopped successfully', 'success');
            } catch (error) {
                console.error('Error stopping countdown:', error);
                showAlert('Error stopping countdown', 'error');
            }
        }

        // Add countdown controls to the listing card
        function createListingCard(listing) {
            const duration = listing.releaseDuration || 0;
            
            return `
                <div class="listing-card" id="listing-${listing.id}">
                    <!-- Existing listing card content -->
                    
                    <!-- Add countdown controls with calculated duration -->
                    <div class="countdown-controls">
                        <select class="countdown-duration">
                            <option value="${duration}" ${duration > 0 ? 'selected' : ''}>
                                ${duration} minutes (Release Time)
                            </option>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="1440">24 hours</option>
                        </select>
                        <button onclick="startCountdown('${listing.id}', document.querySelector('#listing-${listing.id} .countdown-duration').value)">
                            Start Countdown
                        </button>
                        <button onclick="stopCountdown('${listing.id}')">
                            Stop Countdown
                        </button>
                    </div>
                    
                    <!-- Update countdown status display -->
                    ${listing.countdown?.active ? `
                        <div class="countdown-status">
                            Countdown active - Time remaining: ${formatTimeRemaining(listing.countdown.endTime - Date.now())}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Function to update countdown displays in admin panel
        function updateCountdownDisplays() {
            const now = Date.now();
            document.querySelectorAll('.countdown-status').forEach(async status => {
                const listingCard = status.closest('.listing-card');
                const listingId = listingCard.id.replace('listing-', '');
                
                const { data: listing, error } = await supabase
                    .from('listings')
                    .select('countdown')
                    .eq('id', listingId)
                    .single();
                    
                if (!error && listing?.countdown?.active) {
                    const timeLeft = listing.countdown.end_time - now;
                    if (timeLeft > 0) {
                        status.textContent = `Countdown active - Time remaining: ${formatTimeRemaining(timeLeft)}`;
                    } else {
                        status.textContent = 'Countdown ended';
                        stopCountdown(listingId);
                    }
                }
            });
        }

        // Start updating countdown displays
        setInterval(updateCountdownDisplays, 1000);

        // Add this right after Firebase initialization and before any other code
        const allowedUsers = ['vdjq', '_cintillic'];

        // Replace the checkAdminAuth function
        async function checkAdminAuth() {
            const username = localStorage.getItem('currentUser');
            const password = localStorage.getItem('userPassword');

            if (!username || !password) {
                window.location.href = '/dashboard/';
                return;
            }

            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                    
                if (error) throw error;
                
                // Add detailed debug logging
                console.log('Full user data:', userData);
                console.log('Discord Username:', userData?.discord_username);
                console.log('Username:', userData?.username);
                console.log('Discord ID:', userData?.discord_id);
                
                // Verify password matches
                if (!userData || userData.password !== password) {
                    console.error('Invalid credentials');
                    window.location.href = '/dashboard/';
                    return;
                }

                // Check if user is in allowed users list (case-insensitive)
                const isAuthorized = allowedUsers.some(allowedUser => 
                    userData.discord_username?.toLowerCase() === allowedUser.toLowerCase()
                );
                
                console.log('Auth check:', {
                    username: userData.discord_username,
                    isAuthorized: isAuthorized,
                    lowerCaseUsername: userData.discord_username?.toLowerCase(),
                    allowedUsers: allowedUsers
                });

                if (isAuthorized) {
                    // User is authorized - initialize admin features
                    console.log('Admin authorized:', userData.discord_username);
                    document.body.style.display = 'block';
                    initializeListingsListener();
                    initializeUsersListener();
                    initializePaymentsListener();
                    initializeStatsListeners();
                } else {
                    // Not authorized - redirect immediately
                    console.log('User not authorized:', userData.discord_username);
                    window.location.href = '/dashboard/';
                }
                
            } catch (error) {
                console.error('Error checking authorization:', error);
                console.error('Full error:', error);
                window.location.href = '/dashboard/';
            }
        }

        // Call the auth check when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initially hide the content
            document.body.style.display = 'none';
            // Check authentication
            checkAdminAuth();
        });

        async function saveAccountDetails(listingId) {
            try {
                const username = document.getElementById('account-username').value.trim();
                const password = document.getElementById('account-password').value.trim();
                
                const { error } = await supabase
                    .from('listings')
                    .update({
                        account_details: {
                            username: username,
                            password: password
                        }
                    })
                    .eq('id', listingId);
                    
                if (error) throw error;
                showAlert('Account credentials saved successfully', 'success');
            } catch (error) {
                console.error('Error saving account details:', error);
                showAlert('Error saving account details: ' + error.message, 'error');
            }
        }

        async function banIP(ip, reason) {
            try {
                const { error } = await supabase
                    .from('ipbans')
                    .insert([{
                        ip: ip,
                        reason: reason,
                        banned_at: new Date().toISOString(),
                        banned_by: localStorage.getItem('currentUser')
                    }]);
                    
                if (error) throw error;
                
                showAlert('IP banned successfully', 'success');
            } catch (error) {
                console.error('Error banning IP:', error);
                showAlert('Error banning IP: ' + error.message, 'error');
            }
        }

        // Add this to your user management section
        async function getUserIP(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('ip')
                    .eq('username', userId)
                    .single();
                    
                if (error) throw error;
                
                return user?.ip || null;
            } catch (error) {
                console.error('Error getting user IP:', error);
                return null;
            }
        }

        // Add function to calculate duration in minutes
        function calculateDuration(targetTime) {
            const now = Date.now();
            const difference = targetTime - now;
            return Math.max(0, Math.floor(difference / 60000)); // Convert to minutes, minimum 0
        }

        // Add function to format remaining time in a more readable way
        function formatTimeRemaining(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            }
            return `${seconds}s`;
        }

        // Add this function to show order info
        async function showOrderInfo(orderId) {
            const orderInfoModal = document.getElementById('order-info-modal');
            const orderContent = document.getElementById('order-info-content');
            
            orderContent.innerHTML = '<p class="loading">Loading order details...</p>';
            orderInfoModal.style.display = 'flex';
            
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();
                    
                if (error) throw error;
                
                if (order) {
                    const timestamp = new Date(order.created_at);
                    orderContent.innerHTML = `
                        <div class="order-info-grid">
                            <div class="info-group">
                                <label>Order ID:</label>
                                <span>#${orderId.slice(-6).toUpperCase()}</span>
                            </div>
                            <div class="info-group">
                                <label>User:</label>
                                <span>${order.username}</span>
                            </div>
                            <div class="info-group">
                                <label>Discord:</label>
                                <span>${order.discordUsername || 'N/A'}</span>
                            </div>
                            <div class="info-group">
                                <label>Item:</label>
                                <span>${order.listingTitle}</span>
                            </div>
                            <div class="info-group">
                                <label>Price:</label>
                                <span>$${order.price.toFixed(2)}</span>
                            </div>
                            <div class="info-group">
                                <label>Payment Method:</label>
                                <span>${order.paymentMethod}</span>
                            </div>
                            <div class="info-group">
                                <label>Status:</label>
                                <span class="status-badge ${order.status.toLowerCase()}">${order.status}</span>
                            </div>
                            <div class="info-group">
                                <label>Date:</label>
                                <span>${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}</span>
                            </div>
                            ${order.proofUrl ? `
                                <div class="info-group full-width">
                                    <label>Payment Proof:</label>
                                    <img src="${order.proofUrl}" alt="Payment Proof" class="proof-image">
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    orderContent.innerHTML = '<p class="error">Order not found</p>';
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                orderContent.innerHTML = '<p class="error">Error loading order details</p>';
            }
        }
    </script>

    <!-- Add this near the end of your body tag -->
    <div id="order-info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <span class="close-modal" onclick="document.getElementById('order-info-modal').style.display='none'">&times;</span>
            </div>
            <div id="order-info-content"></div>
        </div>
    </div>

    <!-- Add this modal at the end of the body tag -->
    <div id="add-discount-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Discount Code</h2>
                <span class="close-modal" onclick="closeAddDiscountModal()">&times;</span>
            </div>
            <form id="add-discount-form" onsubmit="handleAddDiscount(event)">
                <div class="form-group">
                    <input type="text" id="discount-code" placeholder="Discount Code" required>
                    <label for="discount-code">Discount Code</label>
                </div>
                <div class="form-group">
                    <input type="number" id="discount-percentage" placeholder="Discount Percentage" required min="1" max="100">
                    <label for="discount-percentage">Discount Percentage</label>
                </div>
                <div class="form-group">
                    <input type="number" id="max-uses" placeholder="Maximum Uses" required min="1">
                    <label for="max-uses">Maximum Uses</label>
                </div>
                <div class="form-group">
                    <input type="datetime-local" id="expiry-date" required>
                    <label for="expiry-date">Expiry Date</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-btn">
                        <i class="fas fa-plus"></i> Create Discount
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="module" src="admin.js"></script>

    <!-- The closing body and html tags should be after -->
</body>
</html>

