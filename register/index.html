<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krypton | Register</title>
    <link rel="stylesheet" href="register.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { checkIPBan } from '../auth.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            await checkIPBan();
        });
    </script>
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="register-container">
        <div class="register-header">
            <h1>Create Account</h1>
            <p>Please fill in your information to register</p>
        </div>
        <form id="registerForm" class="register-form">
            <div class="form-group">
                <input 
                    type="text" 
                    id="username" 
                    placeholder="Username" 
                    autocomplete="username"
                    required
                >
            </div>
            <div class="form-group">
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Password" 
                    autocomplete="new-password"
                    required
                >
            </div>
            <button type="submit" class="register-button">Create Account</button>
            <div class="login-link">
                <a href="/login/">Already have an account? Login</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script type="module">
        import { supabase } from '/config/supabase.js';

        // Handle form submission
        const form = document.getElementById('registerForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                // Check if username exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    throw new Error('Username already taken');
                }

                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // Store registration data
                sessionStorage.setItem('pendingRegistration', JSON.stringify({
                    username: username,
                    password: password,
                    ip: userIP,
                    timestamp: Date.now()
                }));

                // Redirect to Discord OAuth
                const params = new URLSearchParams({
                    client_id: '1325220923162230805',
                    redirect_uri: 'https://www.krypt0n.net/discord/callback',
                    response_type: 'code',
                    scope: 'identify'
                });

                window.location.href = `https://discord.com/oauth2/authorize?${params.toString()}`;
            } catch (error) {
                // Show error message
                showError(error.message);
            }
        });

        // Initialize particles.js
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#ffffff'
                },
                shape: {
                    type: 'circle'
                },
                opacity: {
                    value: 0.5,
                    random: false
                },
                size: {
                    value: 3,
                    random: true
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'repulse'
                    },
                    onclick: {
                        enable: true,
                        mode: 'push'
                    },
                    resize: true
                }
            },
            retina_detect: true
        });
    </script>
</body>
</html>
