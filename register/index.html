<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krypton | Register</title>
    <link rel="stylesheet" href="register.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script type="module">
        import { checkIPBan } from '../auth.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            await checkIPBan();
        });
    </script>
</head>
<body>
    <script>
        // Add IP ban check
        checkIPBan();
    </script>
    <div id="particles-js"></div>
    
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="register-container">
        <div class="register-header">
            <h1>Create Account</h1>
            <p>Please fill in your information to register</p>
        </div>
        <form id="registerForm" class="register-form">
            <div class="form-group">
                <input 
                    type="text" 
                    id="username" 
                    placeholder="Username" 
                    autocomplete="username"
                    required
                >
            </div>
            <div class="form-group">
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Password" 
                    autocomplete="new-password"
                    required
                >
            </div>
            <button type="submit" class="register-button">Create Account</button>
            <div class="login-link">
                <a href="/login/">Already have an account? Login</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDvG4059xSr2jToP9xDz-8dlxbumuRzdUE",
            authDomain: "sdfkj238j98sdlkmzlknslaksdjfkl.firebaseapp.com",
            projectId: "sdfkj238j98sdlkmzlknslaksdjfkl",
            storageBucket: "sdfkj238j98sdlkmzlknslaksdjfkl.firebasestorage.app",
            messagingSenderId: "778178162130",
            appId: "1:778178162130:web:a9513f09e404813aa2ec0b",
            measurementId: "G-WP6QR49WZ3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Handle form submission
        const form = document.getElementById('registerForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submitted");

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                // Check if username already exists
                const userDoc = await getDoc(doc(db, 'users', username));
                if (userDoc.exists()) {
                    throw new Error('Username already taken');
                }

                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // Store registration data with IP
                sessionStorage.setItem('pendingRegistration', JSON.stringify({
                    username: username,
                    password: password,
                    ip: userIP,
                    timestamp: Date.now()
                }));

                // Redirect to Discord OAuth
                const params = new URLSearchParams({
                    client_id: '1325220923162230805',
                    redirect_uri: 'https://www.krypt0n.net/discord/callback',
                    response_type: 'code',
                    scope: 'identify'
                });

                window.location.href = `https://discord.com/oauth2/authorize?${params.toString()}`;
            } catch (error) {
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#ff4d4d';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.marginTop = '1rem';
                errorDiv.textContent = error.message;
                
                const existingError = form.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }
                
                errorDiv.className = 'error-message';
                form.appendChild(errorDiv);
            }
        });

        // Initialize particles.js
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#ffffff'
                },
                shape: {
                    type: 'circle'
                },
                opacity: {
                    value: 0.5,
                    random: false
                },
                size: {
                    value: 3,
                    random: true
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'repulse'
                    },
                    onclick: {
                        enable: true,
                        mode: 'push'
                    },
                    resize: true
                }
            },
            retina_detect: true
        });
    </script>
</body>
</html>
